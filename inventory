#!/usr/bin/env bash

###################################
# inventory                       #
# github.com/teccdev/inventory    #
###################################

MODE="none"
RECURSIVE=false
TARGET="."

while [[ $# -gt 0 ]]; do
	case "$1" in
	-h | --help)
		echo "Usage: inventory <mode> [options] [target]"
		echo "Modes:"
		echo "  -c, --count       Count files in the target directory"
		echo "  -s, --size        Show size of the target file or directory"
		echo
		echo "Options:"
		echo "  -h, --help        Show this help message"
		echo "  -r, --recursive   Process directories recursively (for count mode)"
		echo "  -N, --N-decimals  Number of decimal places to show (e.g., -2 for 2 decimal places)"
		echo "  -KB, --kilobytes  Show size in kilobytes (for size mode)"
		echo "  -MB, --megabytes  Show size in megabytes (for size mode)"
		echo "  -GB, --gigabytes  Show size in gigabytes (for size mode)"
		echo
		echo "Examples:"
		echo "  inventory -c /path/to/dir     Count files in directory"
		echo "  inventory -s -r /path/to/dir  Show recursive size of directory"
		echo "  inventory -s -2 file.txt      Show file size with 2 decimal places"
		echo "  inventory -s -MB file.txt     Show file size in megabytes"
		exit 0
		;;
	-c | --count)
		MODE="count"
		shift
		;;
	-s | --size)
		MODE="size"
		shift
		;;
	-r | --recursive)
		RECURSIVE=true
		shift
		;;
	-[0-9] | --[0-9]-decimals)
		DECIMALS=${1//[!0-9]/}
		if ! [[ $DECIMALS =~ ^[0-9]+$ ]]; then
			echo "inventory: invalid number of decimal places"
			exit 1
		fi
		shift
		;;
	-KB | --kilobytes)
		NUMBER_FORMAT="KB"
		shift
		;;
	-MB | --megabytes)
		NUMBER_FORMAT="MB"
		shift
		;;
	-GB | --gigabytes)
		NUMBER_FORMAT="GB"
		shift
		;;
	-*)
		echo "inventory: $1 is not a valid option"
		exit 1
		;;
	*)
		if [ -e "$1" ]; then
			TARGET="$1"
		else
			echo "inventory: $1 is not a file or directory"
			exit 1
		fi
		shift
		;;
	esac
done

if [ $MODE = "count" ]; then
	if [ -d "$TARGET" ]; then
		if [ $RECURSIVE = true ]; then
			COUNT=$(find "$TARGET" -type f | wc -l)
		else
			COUNT=$(find "$TARGET" -maxdepth 1 -type f | wc -l)
		fi
		echo "inventory: there are $COUNT files in $TARGET"
	elif [ -f "$TARGET" ]; then
		echo "inventory: $TARGET is not a directory"
	fi
elif [ $MODE = "size" ]; then
	# Function to format size with specified unit
	format_size() {
		local size=$1
		local unit=${2:-}
		local result=""

		case $unit in
			KB)
				result=$(awk -v size="$size" -v dec="$DECIMALS" 'BEGIN { printf "%0." dec "f", size/1000 }')
				unit="KB"
				;;
			MB)
				result=$(awk -v size="$size" -v dec="$DECIMALS" 'BEGIN { printf "%0." dec "f", size/1000000 }')
				unit="MB"
				;;
			GB)
				result=$(awk -v size="$size" -v dec="$DECIMALS" 'BEGIN { printf "%0." dec "f", size/1000000000 }')
				unit="GB"
				;;
			*)
				# Auto-detect appropriate unit if not specified
				if ((size < 1000)); then
					result=$size
					unit="bytes"
					return
				elif ((size < 1000000)); then
					result=$(awk -v size="$size" -v dec="$DECIMALS" 'BEGIN { printf "%0." dec "f", size/1000 }')
					unit="KB"
				elif ((size < 1000000000)); then
					result=$(awk -v size="$size" -v dec="$DECIMALS" 'BEGIN { printf "%0." dec "f", size/1000000 }')
					unit="MB"
				else
					result=$(awk -v size="$size" -v dec="$DECIMALS" 'BEGIN { printf "%0." dec "f", size/1000000000 }')
					unit="GB"
				fi
				;;
		esac

		# Remove decimal part if DECIMALS is 0
		if [[ -n "$DECIMALS" && $DECIMALS -eq 0 ]]; then
			result=${result%.*}
		fi

		echo "$result $unit"
	}

	if [ -d "$TARGET" ]; then
		if [ $RECURSIVE = true ]; then
			FILE_SIZE=$(find "$TARGET" -type f -exec stat -c%s {} + | awk '{sum+=$1} END {print sum}')
			FILES=$(find "$TARGET" -type f | wc -l)
			if [ -n "$NUMBER_FORMAT" ]; then
				FORMATTED_SIZE=$(format_size "$FILE_SIZE" "$NUMBER_FORMAT")
				echo "inventory: $TARGET is $FORMATTED_SIZE across $FILES files"
			else
				echo "inventory: $TARGET is $FILE_SIZE bytes across $FILES files"
			fi
		else
			FILE_SIZE=$(find "$TARGET" -maxdepth 1 -type f -exec stat -c%s {} + | awk '{sum+=$1} END {print sum}')
			FILES=$(find "$TARGET" -maxdepth 1 -type f | wc -l)
			if [ -n "$NUMBER_FORMAT" ]; then
				FORMATTED_SIZE=$(format_size "$FILE_SIZE" "$NUMBER_FORMAT")
				echo "inventory: $TARGET is $FORMATTED_SIZE across $FILES files"
			else
				echo "inventory: $TARGET is $FILE_SIZE bytes across $FILES files"
			fi
		fi
	else
		if [ $RECURSIVE = true ]; then
			echo "inventory: $TARGET is not a directory"
			exit 1
		else
			FILE_SIZE=$(stat -c%s "$TARGET")
			if [ -n "$NUMBER_FORMAT" ]; then
				FORMATTED_SIZE=$(format_size "$FILE_SIZE" "$NUMBER_FORMAT")
				echo "inventory: $TARGET is $FORMATTED_SIZE"
			else
				if ((FILE_SIZE < 1000)); then
					echo "inventory: $TARGET is $FILE_SIZE bytes"
				else
					FORMATTED_SIZE=$(format_size "$FILE_SIZE")
					echo "inventory: $TARGET is $FORMATTED_SIZE"
				fi
			fi
		fi
	fi
else
	echo "inventory: no mode specified (use --help for a list of options)"
fi
